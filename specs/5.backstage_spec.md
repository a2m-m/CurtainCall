---
tags: []
---

# バックステージ（#/phase/backstage, #/phase/backstage/gate）

## 目的

- スポットライトでセットを公開したものの、同ランクの手札がなくペアを作れなかった場合に、もう一方のプレイヤーへ救済行動を与える。
- 直前スポットライトで公開を担当しなかった側がカード情報を追加公開するか、保険として1枚を手札に取り込む。
- 処理完了後はインターミッションへ自動移行し、次ターンのハンドオフに備える。

## 到達条件

- スポットライトの任意公開が**非JOKER**で終了し、ペアが成立しなかった。
- そのスポットライトでカードを公開「しなかった」プレイヤーに行動権がある。
- バックステージに未公開カードが残っている。

上記を満たす場合、スポットライト終了後に **#/phase/backstage/gate** へ遷移する。それ以外は従来どおりインターミッションへ進む。

## 入口（ハンドオフゲート）

- 見出し：バックステージ
- サブタイトル：バックステージアクション担当のプレイヤー名を表示。
- ボタン：
  - **［バックステージ］**：公開処理のダイアログを開く（行動可能時のみ表示）。
  - **［ボードチェック］**：公開情報の確認モーダル。
  - **［前ラウンド要約］**：公開履歴の要約モーダル。
- モーダルの確定ボタンは**［バックステージへ］**。行動完了後に自動でインターミッションビューへ移行し、必要に応じてそこからインターミッションゲートの確認モーダルを開く。

## フロー

1. **ゲート到達**
   - 行動者を明示し、上記アクションボタンを提示。行動者以外には実行できない。
   - バックステージカードがすべて公開済み／行動済みなら、案内のみでゲート通過可。

2. **バックステージ公開ダイアログ**
   - メッセージ：直前スポットライトが不成立だった旨と、公開できるカード一覧。
   - カード一覧：未公開カードを `CardComponent` で表示し、それぞれボタン化。
   - 操作：任意の1枚を選択すると即座に公開処理へ進む。
   - 右下に **［スキップ］**。スキップ時は公開せずに終了（行動済み扱い）。

3. **公開結果**
   - 一致した場合：
     - `backstage.items` の対象カードをステージ（シモ）へ移動し、スポットライトで公開されていたカードをカミへ配置してペア成立。
     - `set.opened` の該当エントリに `assignedTo` と `bonus: "pair"` を付与。
     - トースト：`一致！セットのカードとペアが成立しました。`
   - 不一致の場合：
     - 公開カードは公開情報として残しつつ、`INTERMISSION_BACKSTAGE_RESULT_MISMATCH` を表示。
     - 続けて「取得ダイアログ」へ遷移。

4. **取得（不一致時のみ）**
   - タイトル：`バックステージから取得`
   - 内容：残りの非公開カードを一覧表示。1枚選んで自分の手札に加える（非公開処理）。
   - 取得後は `actedThisIntermission = true` とし、ゲートへ戻らず自動で完了判定。

5. **完了と遷移**
   - 行動完了・スキップ・取得いずれでも `actedThisIntermission = true` となり、自動で **#/phase/intermission** へ移動。
   - 以後同一インターミッション中に追加アクションは行えない。

## UI と文言

- ゲート：`バックステージアクションを完了するとインターミッションへ移動します。公開またはスキップの処理を行ってください。`
- ダイアログ本文：`直前のスポットライトでペア不成立でした。あなたはバックステージから1枚公開できます（1回）。処理が終わると自動的にインターミッションへ進みます。`
- スキップボタン：`スキップ`
- 取得ダイアログ：`手札に加えるカードを選んでください（非公開）`
- 完了トースト：`バックステージアクションを完了しました。`

## ガード／例外

- 行動条件を満たしていない場合：`バックステージアクションを実行できる状態ではありません。`
- 公開可能なカードが無い場合：`公開できるカードは残っていません。`
- 取得候補が無い場合：`これ以上取得できるカードはありません。`
- スキップ後や行動完了後に再びバックステージゲートへ戻ろうとすると、即座にインターミッションへ誘導される。
- 行動中にブラウザバック等でルートがずれても、`autoAdvanceFromBackstage` により完了次第インターミッションへ再同期。

## 状態更新（例）

```
"backstage": {
  "items": [
    { "id": "B-03", "card": {"rank": "7", "suit": "hearts", "value": 7}, "status": "stage", "holder": "nox", "isPublic": true, "revealedAt": 1737654321000, "revealedBy": "nox", "stagePairId": "pair-20251001" },
    { "id": "B-04", "card": {"rank": "Q", "suit": "spades", "value": 12}, "status": "backstage", "holder": null, "isPublic": false }
  ],
  "pile": 8,
  "lastSpotlightPairFormed": false,
  "canActPlayer": "nox",
  "actedThisIntermission": true
}
```

- `canActPlayer`：今回の行動者（公開を担当しなかった側）。
- `actedThisIntermission`：完了後は `true` に固定。インターミッション突入時にリセットされる。
- `lastSpotlightPairFormed`：スポットライトでペア成立済みなら `true`、バックステージへは遷移しない。

