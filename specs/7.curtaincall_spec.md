---
tags: []
---
# **カーテンコール（/phase/curtaincall）— 完全版**

  

## **役割**

- **公開ポップアップ**で告知 → **結果画面**で勝敗と集計を表示。
    
- 画面下部に **HOME／新しいゲーム／結果の保存** を常設。
    

---

## **入口（公開ポップアップ）**

- 全画面モーダル（背景暗幕）
    
    - 見出し：**カーテンコール（結果発表）が始まります**
        
    - 説明：この結果は両者で確認できます。
        
    - **［OK（結果を見る）］** → 結果画面へ
        
    

---

## **結果画面 UI**

- ヘッダー：カーテンコール（右上：**［ボードチェック］**＝最終盤面の参照）
    
- 勝敗バナー：
    
    - 例）**プレイヤーAの勝ち（+12）** ／ **プレイヤーBの勝ち（+7）** ／ **引き分け**
        
    
- **スコア明細カード（左右に並列）**
    
    - 見出し：**プレイヤーA**／**プレイヤーB**
        
    - 行1：**カミ合計**（自分ステージの“カミ”に配置されたカードの数字合計）
        
    - 行2：**手札合計**（最終手札の数字合計）
        
    - 行3：**ブーイングペナルティ**（条件付き、0 のこともある）
        
    - 仕切り
        
    - **最終ポイント**＝ _カミ合計 − 手札合計 − ペナルティ_
        
    - 補足：ブーイング達成：X/3（各自の達成度を表示）
        
    
- 画面下部の固定ボタン：
    
    - **［HOME］**／**［新しいゲーム］**／**［結果の保存］**
        
    

  

> **ボードチェック**では、最終の**セット残数／各ステージ内容（カミ/シモの公開可能情報）／最終スコア**を参照可（読み取り専用）。

---

## **集計ルール**

- **最終ポイント**（プレイヤー p）
    
    \text{FINAL}_p = \text{SUM\_KAMI}_p \;-\; \text{SUM\_HAND}_p \;-\; \text{PENALTY}_p
    
- **SUM_KAMI**：自ステージの**カミ**（上段）に置かれたカードの**数字**合計。
    
    - ※ **シモ**（下段）は合計に含めない。
        
    - ※ 絵札やAの数え方は**ルールブック準拠**（実装時は rankValue(card) を使う）。
        
    
- **SUM_HAND**：最終手札の**数字**合計（同じく rankValue 準拠）。
    
- **PENALTY**：**カーテンコールの発動理由が「セット残1（山札が1枚）」**のときのみ適用。
    
    - 各プレイヤーの**不足ブーイング数** ＝ max(0, 3 - booCount[p])
        
    - **ブーイングペナルティ** ＝ 不足ブーイング数 × 15
        
    - ※ **JOKERを理由にカーテンコール**へ来た場合は**ペナルティなし**。
        
    
- **勝敗**：最終ポイントが**大きい方が勝利**。同点は**引き分け**。
    

---

## **ボタン挙動**

- **HOME** → /
    
- **新しいゲーム** → /standby（前回データは確認後クリア）
    
- **結果の保存** → 保存モーダル
    
    - 入力：**タイトル**（例：2025/09/24_第12局）、**メモ**（任意）
        
    - 保存内容：
        
        - 対局ID／日時
            
        - 勝者／両者の最終ポイント・差分
            
        - **明細**（各行の内訳：カミ一覧と合計／手札一覧と合計／ペナルティの内訳）
            
        - 最終盤面スナップショット（公開情報のみ）
            
        
    - 完了：トースト結果を保存しました／再閲覧用リンク
        
    

---

## **例外・ガード**

- **rankValue**（A/J/Q/K/JOKER の扱い）は**ルールブックに合わせる**（アプリ側は設定可能にしてもよい）。
    
- **負のスコア**は許容（そのまま表示）。
    
- **カミが0枚**のプレイヤーは SUM_KAMI=0 として計算。
    
- **手札が空**なら SUM_HAND=0。
    
- ペナルティは**各プレイヤーごと**に独立して計算。
    
- 結果画面は**読み取り専用**（盤面編集不可）。
    
- 連打ロック（200–400ms）。
    

---

## **状態（例）**

```
{
  "phase": "curtaincall",
  "reason": "setRemaining1",              // "jokerBonus" | "setRemaining1"
  "booCount": { "lumina": 2, "nox": 3 },
  "rankValueRule": "rulebook_default",

  "lumina": {
    "kamiCards": ["S A","D 7","H 9"],    // 表向きカミ
    "handCards": ["C 2","C 5"],          // 最終手札
    "sumKami": 1+7+9,
    "sumHand": 2+5,
    "penalty": (reason==="setRemaining1" ? Math.max(0,3-2)*15 : 0),  // =15
    "final": 17 - 7 - 15                  // = -5
  },

  "nox": {
    "kamiCards": ["C K","H 3"],          // 13+3
    "handCards": ["S 4"],
    "sumKami": 16,
    "sumHand": 4,
    "penalty": (reason==="setRemaining1" ? Math.max(0,3-3)*15 : 0),  // =0
    "final": 16 - 4 - 0                   // = 12
  },

  "winner": "nox",                        // "lumina" | "nox" | "draw"
  "margin": 17
}
```

---

## **受け入れ基準**

- 入口で**「カーテンコールが始まります」**の公開ポップアップを表示し、**OK**で結果へ。
    
- 結果画面に**勝敗**と**スコア明細（カミ合計／手札合計／ペナルティ／最終ポイント）**が両者分表示される。
    
- **ペナルティ**は**セット残1**が理由のときだけ適用。
    
- **最終ポイント＝カミ合計−手札合計−ペナルティ**で正しく算出し、勝敗判定される。
    
- 下部に**HOME／新しいゲーム／結果の保存**が常設され、押下時に正しく遷移／保存できる。