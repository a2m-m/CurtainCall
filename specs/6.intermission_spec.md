# インターミッション（#/phase/intermission, #/phase/intermission/gate）

## 目的

- 手番を相手へ引き継ぐためのハンドオフ専用フェーズ。
- 直前までの公開情報を整理しつつ、秘匿情報を画面から退避する。
- バックステージ処理（必要な場合）が完了していることを確認してから次ターンへ進む。
- 次ターンを開始できるだけの手札枚数が両者に残っているかを判定し、続行不能ならカーテンコールへ引き渡す。

## 到達経路

- ウォッチでクラップが選択された場合：ウォッチ → インターミッション。
- スポットライトでペア成立またはセット残1枚：スポットライト → インターミッション。
- スポットライトでペア不成立：スポットライト → バックステージ → インターミッション（バックステージ完了後に自動遷移）。
- セットからJOKERが出た／セット残1枚のときはカーテンコールへ直行し、本フェーズは発生しない。

## 入口（ハンドオフゲート）

- 見出し：手番交代。
- サブタイトル：`次は{次手番プレイヤー名}の番です`。
- ボタン：
  - **［OK（スカウトへ）］**：ゲート通過。`activePlayer` を交代し、ターン数を加算して /phase/scout へ遷移。
  - **［ボードチェック］**：公開情報の参照モーダル（セット残・各ステージ・スコア）。
  - **［前ラウンド要約］**：直前ラウンドの公開サマリー。秘匿情報は含めない。
- バックステージが未完了のまま到達した場合は、OK押下時に `バックステージアクションを実行するか、スキップしてください。` を表示し、その場に留まる（通常はバックステージ完了後にしか到達しない）。

## フロー

1. **ゲート到達**
   - 画面全体を暗転し、秘匿情報は未描画。ボードチェック／要約のみ操作可能。
   - バックステージ未完了の場合はスポットライト終了時点で自動的にバックステージゲートへ誘導されるため、通常この画面には到達しない。万一直接アクセスした場合はガードメッセージを表示してハンドオフを拒否する。
2. **ゲート通過**
   - `OK` を押すと `activePlayer` を交代し、`turn.count` を+1、`watch.decision` をリセットして `/phase/scout` へ移動。
   - `backstage` 情報は保持したまま。次のスポットライトでセット公開が行われる際に `actedThisIntermission` が自動で `false` に戻る。
   - ゲート通過直前に次のスカウト担当の手札枚数を確認し、以下のいずれかに該当した場合はターン更新を行わず `reason = "handDepleted"` のカーテンコールを準備して `/phase/curtaincall/gate` へ遷移する。
     - 次のスカウト担当プレイヤーの手札が0枚。
     - 次のスカウト担当プレイヤーの手札が1枚、かつ相手プレイヤーの手札が0枚。

## 表示内容

- ヘッダー：手番交代。
- 本文：`端末を次のプレイヤーに渡してください。` などの指示（ゲート共通文言に準拠）。
- ボードチェック／前ラウンド要約モーダルでは公開情報のみを列挙。手札・裏面情報は扱わない。

## ガード・非機能要件

- ゲート通過までは秘匿情報（手札・裏面カード）をDOMへ描画しない。
- ボタンには連打防止ロック（200–400ms）を適用。
- ブラウザ戻る操作時は前フェーズの公開要約のみを再表示し、秘匿情報は復元しない。
- 手札枯渇によるカーテンコール移行条件はインターミッションのみで評価し、条件成立時はハンドオフゲートを抜けずに終了処理へ誘導する。

## 状態更新（例）

```
{
  "phase": "intermission",
  "activePlayer": "nox",
  "turn": { "count": 12, "startedAt": 1737654400000 },
  "backstage": {
    "items": [...],
    "pile": 8,
    "lastSpotlightPairFormed": false,
    "canActPlayer": null,
    "actedThisIntermission": true
  },
  "watch": { "decision": null, "nextRoute": null }
}
```

- `actedThisIntermission` は直前のバックステージで行動済みなら `true`。次のスポットライトでセット公開が発生した時点で `false` にリセットされる。
- バックステージが発生しなかったターンでは `canActPlayer` が `null` のまま、`actedThisIntermission` も `true` として扱う。

## 文言（例）

- 見出し：手番交代／次は{次手番プレイヤー名}の番です。（例：先手がプレイヤーAの場合は「次はプレイヤーBの番です。」）
- ボタン：OK（スカウトへ）／ボードチェック／前ラウンド要約。
- ガードメッセージ：`バックステージアクションを実行するか、スキップしてください。`

