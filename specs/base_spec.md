# カーテンコール｜HTML/CSS/JS版 要件定義書（SRS）

最終更新: 2025-09-24 / 対象: GitHub Pages で静的公開する SPA（純粋な HTML/CSS/JavaScript）

---

## 1. 目的と背景

2人対戦カードゲーム「カーテンコール」を、**サーバーレス**かつ**1端末交互操作**で安全に遊べるように実装する。公開先は GitHub Pages。覗き見対策として「ハンドオフゲート（全画面 OK モーダル）」を各所に設置し、手番交代や手札表示の前後で確実に画面ブロックする。

---

## 2. 参照資料（インプット）

- `/rulebook.md`
- `/specs/0.HOME_spec.md`
- `/specs/1.standby_spec.md`
- `/specs/2.scout_spec.md`
- `/specs/3.action_spec.md`
- `/specs/4.watch_spec.md`
- `/specs/5.spotlight_spec.md`
- `/specs/6.intermission_spec.md`
- `/specs/7.curtaincall_spec.md`
- `/specs/8.boardcheck_spec.md`

---

## 3. 用語定義（抜粋）

- **ルミナ / ノクス**: プレイヤー役割。初回ターンはルミナ先攻、以後は交互に交代。
- **ステージ**: カードを提示・配置する場。自分用に **カミ（表/役者札）** と **シモ（裏/黒子札）** がある。
- **セット**: メインステージに表向き未公開で並ぶ 13 枚。
- **役者札 / 黒子札**: それぞれカミ(表) / シモ(裏)に置かれるカード。
- **クラップ / ブーイング**: ウォッチフェーズで選択する行為。ブーイング回数はゲーム上の要件に影響。
- **ハンドオフゲート**: 情報秘匿のための全画面 OK モーダル。OK まで手札や秘匿情報は描画しない。
- **レジュームゲート**: 続きから再開時の安全確認用ゲート。

---

## 4. スコープ

- 対応端末: **スマホ / タブレット** 縦横両対応（スクロール無しで収まる設計を優先）。
- 技術: プレーンな HTML/CSS/JS（ES Modules）。ビルドツール不要。
- 保存: `localStorage` にオフライン保存（途中セーブ/再開）。
- 通信: なし（完全オフライン動作）。

---

## 5. 画面・ルーティング

- `/` HOME
- `/standby` スタンバイ
- `/phase/scout` スカウト
- `/phase/action` アクション
- `/phase/watch` ウォッチ
- `/phase/spotlight` スポットライト
- `/phase/intermission` インターミッション
- `/phase/curtaincall` カーテンコール
- `/resume/gate` レジュームゲート
- 各フェーズに必要な **/gate**（ハンドオフゲート）を用意（例: `/phase/watch/gate`）。
- ルーティング方式: **ハッシュベース**（`#/phase/scout` など）— GitHub Pages での 404 回避。

---

## 6. 全体フロー（要約）

1. **HOME**: 新規開始 or 続きから。続きからは `/resume/gate` 経由。
2. **スタンバイ**: 初期設定→「スタンバイ中」→「完了」→ **ゲート** → スカウトへ。
3. **スカウト**: 相手の手札から 1 枚引く（中身は見えない）。完了後アクションへ。
4. **アクション**: 自手札から **役者1／黒子1** を自分ステージに配置→ウォッチへ。
5. **ウォッチ**: 相手は **クラップ/ブーイング** を選択（ブーイング不足警告ロジックあり）。
6. **スポットライト**: 黒子公開→判定→行動権決定→（任意）セット 1 枚オープン。**JOKER オープン時は追加1枚オープン＋自動ペア→カーテンコールへ**。
7. **インターミッション**: 手番交代の中継。秘匿情報は非表示。→ スカウトへ戻る。
8. **カーテンコール**: 勝敗と集計表示。下部に HOME／新しいゲーム／結果の保存。

---

## 7. 機能要件

### 7.1 HOME（`/`）

- 構成: **ゲーム開始／つづきから／設定／ヘルプ**。スクロール無し。
- 受入: 「ゲーム開始」→即 `/standby`。 「つづきから」→ **必ず** `/resume/gate` 経由。

### 7.2 スタンバイ（`/standby`）

- 初期設定 UI（先手決定、プレイヤー名など）。
- 受入: 先手未決定時は開始不可。**はじめる → スタンバイ中 → スタンバイ完了 → ゲート OK → `/phase/scout`**。
- ゲート中は盤面/手札/秘匿情報を描画しない。

### 7.3 スカウト（`/phase/scout`）

- \*\*相手の手札一覧（裏）\*\*から 1 枚選択→「これを引く」。確認ダイアログ→確定。
- 取得直後に **「{CARD\_LABEL} のカードを引きました！」** を公開ポップアップ表示。
- **自分の手札**と**自分から取られたカード**を参照可能。盤面は共通「ボードチェック」にて。
- 決定後に **アクションへ**。アクション UI は決定まで非表示。

### 7.4 アクション（`/phase/action`）

- 自手札から **役者(表)／黒子(裏)** を各 1 枚選択し、自分ステージ **カミ/シモ** に配置。
- 「配置を確定」確認後は巻き戻し不可。完了ポップアップ→**ウォッチへ**。
- **手札は常時フッター表示**（横スクロール可）。
- 交代時や秘匿表示前は必ず `/phase/watch/gate` を経由。

### 7.5 ウォッチ（`/phase/watch`）

- 相手は **クラップ / ブーイング** を 1 ターンにつき **1 回だけ**選択できる。
- カウンタ表示: **あなたのブーイング X/3**（ゲーム単位で集計）。
- **ブーイング運用（確定）**: ブーイングはゲーム全体で 3 回達成を目標とする（§7.8 ペナルティ参照）。
- **不足見込み時の扱い（確定）**: 不足見込みの局面では **警告のみを表示**し、**強制はしない**（プレイヤーの自由選択を尊重）。
- 遷移: **クラップ → インターミッション**｜**ブーイング → スポットライト**。

### 7.6 スポットライト（`/phase/spotlight`）

- **到達条件**: **ウォッチでブーイングが選択された場合のみ**突入する（クラップはスポットライトを経由せずインターミッションへ）。
- **処理順**: ① 黒子公開 → ② 判定（judge）→ ③ 行動権決定 → ④ **セット 1 枚オープン（任意・1 回/本フェーズ）** → ⑤（非JOKERかつ同ランク手札ありなら）**非公開でペア配置**。
- **判定（judge）**: `match` ＝ **役者札と黒子札のランクが一致**（スートは不問）／`mismatch` ＝ 不一致。
- **読みの正否**: スポットライト到達時点でウォッチの選択は **ブーイング** なので、`booCorrect = (judge == "mismatch")`。
- **行動権・帰属**:
  - `booCorrect = true`（不一致的中）→ **ペアの帰属はブーイング側**／**セットの任意オープン権（openControl）もブーイング側**。
  - `booCorrect = false`（一致で外れ）→ **ペアの帰属はプレゼンター**（アクション実行者）／**openControl はプレゼンター**。
- **セットの任意オープン**: **各スポットライトにつき 1 回**。実行主体は上記 **openControl** のプレイヤー。
- **JOKERボーナス**: セットから **JOKER** をオープンした場合、**同フェーズ内で追加でもう 1 枚自動オープンし、自動でペアを作成**。そのまま **カーテンコール**へ遷移する（ペナルティは発生しない）。
- **非公開ペア**: セットでオープンしたカードが **非JOKER** かつ、行動権側の**手札に同ランク**があれば、**カミ＝オープン札／シモ＝手札札**で自動または選択式でペアを作る（ハンドオフゲート経由で手札を表示）。

### 7.7 インターミッション（`/phase/intermission`）

- 手番を相手へ切替えるのみ。秘匿情報は非表示。
- 条件が無ければ **ハンドオフゲート**のみ表示→OK 後 `/phase/scout`。
- `activePlayer` と `turn` を更新。

### 7.8 カーテンコール（`/phase/curtaincall`）

- 入口で **「カーテンコールが始まります」** の公開ポップアップ→OK で結果画面へ。
- 結果画面に **勝敗**と **スコア明細（カミ合計／手札合計／ペナルティ／最終ポイント）** を両者分表示。
- **ブーイングペナルティ**: セット残 1 による終了時のみ適用。`penalty = max(0, 3 - booCount) * 15`。**JOKER 終局ではペナルティなし**。
- 最終ポイント: `final = SUM_KAMI - SUM_HAND - PENALTY`。大きい方が勝利。同点は引き分け。
- 下部ボタン: **HOME／新しいゲーム／結果の保存**。
- **結果の保存（正式）**: **テキスト要約**として `localStorage` に履歴保存。保存内容は `{日時, 勝者, ルミナ/ノクスの最終ポイント, ブーイング回数, 終了理由(JOKER/SET1), セットオープン回数}` を行単位で記録し、HOME の **「履歴」** から一覧参照・コピー可能。必要に応じて 1 件詳細（明細テキスト）も表示。

---

## 8. ルール/ロジック仕様

- **デッキ構成（確定）**: 通常のトランプ **52 枚 + JOKER 1 枚 = 計 53 枚**。
- **初期配分（確定）**: スタンバイで **セットに 13 枚**を表向き未公開で配置し、**残り 40 枚のうち 30 枚をプレイヤーへ（15 枚ずつ）、10 枚をバックステージに配置する**。**山札は残らない**（追加ドローなし）。
- **終了条件**: ① セットから **JOKER** が登場したとき。② セット残りが **1 枚**になったとき。
- **スコア集計**: カミ合計・手札合計を双方で算出。ペナルティは下記（§7.8）。
- **ランク値（数値化）**: 【仮定】`A=1, 2-10=数字, J=11, Q=12, K=13, JOKER=0（加点対象外）`。※設定画面で変更可能にする。

---

## 9. データモデル（JSON 例）

```json
{
  "players": [
    {
      "id": "lumina",
      "name": "ルミナ",
      "role": "lumina",
      "hand": [/* Card[15] */],
      "stage": {"kami": [], "shimo": []},
      "booCount": 0,
      "clapCount": 0,
      "score": {"sumKami": 0, "sumHand": 0, "penalty": 0, "final": 0}
    },
    {
      "id": "nox",
      "name": "ノクス",
      "role": "nox",
      "hand": [/* Card[15] */],
      "stage": {"kami": [], "shimo": []},
      "booCount": 0,
      "clapCount": 0,
      "score": {"sumKami": 0, "sumHand": 0, "penalty": 0, "final": 0}
    }
  ],
  "set": { "cards": [/* Card[13] */], "opened": [] },
  "activePhase": "scout",
  "activePlayer": "lumina",
  "turn": 1,
  "history": [],
  "meta": { "composition": { "total": 53, "joker": 1, "set": 13, "perHand": 15, "backstage": 10 } },
  "resume": { "at": "2025-09-24T10:00:00+09:00", "phase": "scout", "player": "lumina" }
}
```

**Card**

```json
{ "id": "S-10", "rank": "10", "suit": "S", "value": 10, "faceUp": false }
```

---

## 10. 状態遷移（要約）

| From                  | 操作/条件           | To                                   |
| --------------------- | --------------- | ------------------------------------ |
| `/`                   | ゲーム開始           | `/standby`                           |
| `/`                   | つづきから           | `/resume/gate` → 保存先                 |
| `/standby`            | スタンバイ完了→OK      | `/phase/scout`                       |
| `/phase/scout`        | 引く→完了           | `/phase/action`                      |
| `/phase/action`       | 配置確定            | `/phase/watch/gate` → `/phase/watch` |
| `/phase/watch`        | クラップ            | `/phase/intermission`                |
| `/phase/watch`        | ブーイング           | `/phase/spotlight`                   |
| `/phase/spotlight`    | JOKER オープン      | 自動ペア → `/phase/curtaincall`          |
| `/phase/spotlight`    | 非JOKER & 同ランクあり | 非公開でペア → `/phase/intermission`       |
| `/phase/intermission` | OK              | `/phase/scout`（手番交代）                 |
| 任意                    | 終了条件成立          | `/phase/curtaincall`                 |

---

## 11. UI/UX 要件

- **スクロール無し**で主要要素が収まるレイアウト。安全領域（notch）考慮。
- **ハンドオフゲート**: 手番交代・手札初表示・レジューム時に必ず表示。OK まで秘匿情報は未描画。
- **手札**: フッター固定（横スクロール）。選択状態の視覚化。
- **ボードチェック**: 盤面公開情報のサマリをいつでも参照（モーダル）。
- **ポップアップ/トースト**: フェーズ完了、カード取得、オープン結果等を明示。
- **アクセシビリティ**: モーダルはフォーカストラップ/`aria-*` 対応、コントラスト比 4.5:1 以上、全操作はキーボード操作可能。

---

## 12. 非機能要件

- **パフォーマンス**: 初期ロード < 200KB（画像含まず）。カードは CSS/テキスト描画を既定とし、画像利用時も遅延読込。
- **可用性**: オフラインでプレイ継続可能。保存は自動/手動（HOME・結果画面）。
- **互換性**: 最新の Safari/Chrome/Firefox/Edge（モバイル/タブレット）を対象。
- **セキュリティ**: 端末共有前提。秘匿情報は DOM にも載せない（ゲート前は placeholder）。

---

## 13. リポジトリ構成（提案）

```
/ (root)
  ├─ index.html
  ├─ assets/
  │   ├─ css/style.css
  │   ├─ js/
  │   │   ├─ main.js          # ルーター/ブート
  │   │   ├─ store/state.js   # ゲーム状態と永続化
  │   │   ├─ store/rules.js   # ルール/判定ロジック
  │   │   ├─ components/      # Modal, Hand, Board, Stage など
  │   │   └─ phases/
  │   │       ├─ home.js
  │   │       ├─ standby.js
  │   │       ├─ scout.js
  │   │       ├─ action.js
  │   │       ├─ watch.js
  │   │       ├─ spotlight.js
  │   │       ├─ intermission.js
  │   │       └─ curtaincall.js
  │   └─ img/cards/ (任意)
  └─ docs/ (仕様・ガイド)
```

---

## 14. ストレージ仕様（localStorage）

- `cc:save:latest` — 直近オートセーブ（GameState 丸ごと JSON）
- `cc:save:slots:{n}` — 手動スロット保存
- `cc:history:list` — **結果履歴（テキスト要約の配列）**
- セーブ時メタ: `{ savedAt, phase, activePlayer, turn }`
- 再開は **/resume/gate** で確認後にロード→遷移
- 履歴 UI: HOME から「履歴」画面で一覧/コピー。**最大保持件数【仮定: 50 件】**、超過時は FIFO で古い順に削除。

---

## 15. 開発ガイド（要点）

- ES Modules＋ハッシュルーター。各フェーズは `mount(root, state)` をエクスポート。
- ゲートは共通 `showGate({ text, onOk })` を利用。
- ルール系は `rules.js` に隔離（ブーイング不足警告、JOKERボーナス、終了判定、スコア計算）。
- DOM 反映は差分更新（`data-*` とイベント委譲）。
- ユニットテスト（任意）: `rules.spec.js`（終了判定/スコア計算/ブーイング不足警告）。

---

## 16. テスト観点（抜粋）

- **HOME**: 続きから→必ず `/resume/gate` を通る。
- **スタンバイ**: 先手未決定で開始不可。ゲート中に手札が DOM に出ない。
- **スカウト**: 引いたカードのラベルが正しく表示される。巻き戻し不可。
- **アクション**: 役者/黒子 各1枚選択が必須。確定後の戻し不可。手札はフッター固定。
- **ウォッチ**: `needed >= r` で不足警告を点灯。文言にカウンタが反映。
- **スポットライト**: JOKER オープン→追加1枚→自動ペア→カーテンコール。
- **インターミッション**: 手番とターンが更新され、秘匿情報は常に非表示。
- **カーテンコール**: スコア式 `final = sumKami - sumHand - penalty` が一致。JOKER終局では penalty=0。
- **仕様整合性（rulebook/各仕様書 vs SRS）**:
  - **用語/数値/分岐の一致**: デッキ構成、初期手札15枚×2＋バックステージ10枚、セット13、終了条件（JOKER登場/SET残1）、JOKERボーナスの挙動、セット任意オープン1回/スポットライト、行動権の帰属（ブーイング的中時＝ブーイング側）に齟齬がない。
  - **フェーズ遷移の一致**: 各仕様書に記載のフローと `状態遷移` 表が一致。
  - **UIイベントの一致**: ハンドオフゲートの表示条件、公開/非公開の切替タイミング、確認ダイアログの有無が一致。
  - **監査手順**: 参照資料ごとに SRS の対応セクション（§番号）をチェックリスト化し、**差分があれば SRS を更新**。`変更履歴` の更新をもって回帰テストトリガー。

---

## 17. デプロイ

- GitHub Pages（`main` ブランチ `/` 直下公開 もしくは `gh-pages`）。
- ルーティングは **ハッシュ方式**に限定。`index.html` のみで動作。

---

## 18. リスク/制約

- 1端末交互プレイのため、覗き見防止は**運用＋ゲート UI**に依存。
- サーバー検証が無いため、完全な不正防止は不可。

---

## 19. 確認事項（曖昧点）

1. **履歴保持件数**：既定 50 件で問題ないか（変更可能）。
2. **履歴の共有手段**：コピー以外に、ワンクリックで `.txt` ダウンロードを付けるか。

---

## 20. 【仮定】（実装を進めるための暫定）

- **ランク値マップ** は既定（A=1…K=13, JOKER=0）で例外なし。
- **保存スロット** は 3 つ（`slots:0..2`）。
- **設定画面** は当面：プレイヤー名、ランク値マップ、効果音 ON/OFF のみ。
- **履歴保持件数**：50 件。

> 仮定は確定後に SRS を更新する。

---

## 21. 変更履歴

- 2025-09-24: 初版作成（参照資料の要点を統合し、SPA/ハッシュルーター/ローカル保存の実装方針を定義）。

